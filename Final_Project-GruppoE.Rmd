# Progetto Finale - Gruppo E
#### Giacomo Serafini, Enrico Guerriero, Leonardo Marsich, Gilberto Bran

### Data Set
Il dataset *WiscNursingHome* racchiude le informazioni riguardo diverse centinaia di case di riposo, informazioni che poi saranno utilizzate per prevedere il costo??? della struttura negli anni successivi.   
Nel dataset sono presenti 12 variabili:

* *hospID*: l'ID rappresentativo della singola struttura
* *CRYEAR*: il rapporto dei costi annuo
* *TPY*: il totale pazienti annui
* *NUMBED*: il numero di letti
* *SQRFOOT*: il numero di piedi quadrati della struttura
* *MSA*: codice dell'area statistica metropolitana (area divisa in 13 zone, più lo 0 se rurale)
* *URBAN*: 1 se urbana, O se rurale
* *PRO*: 0 se non-profit, 1 altrimenti
* *TAXEXEMPT*: 1 se esente dalle tasse
* *SELFFUNDINS*: 1 se autofinanziato per l'assicurazione
* *MCERT*: 1 se certificato Medicare
* *ORGSTR*: 1 se con finalità di lucro, 2 se esente dalle tasse, 3 se unità governativa

L'obiettivo della nostra analisi sarà quindi quello di capire come le varie caratteristiche di una casa di riposo sono tra loro collegate (se collegate in alcun modo), per poter così prevedere tutto ciò che concerne una struttura negli anni successivi, o perfino prevedere il futuro di una nuova struttura.   
In maniera particolare, vogliamo analizzare quali sono le principali peculiarità di una struttura che portano ad avere un numero maggiore di pazienti.

```{r include=FALSE}
# Richiamo delle librerie
library(corrplot)
library(ggplot2)
library(cowplot)
library(dplyr)
library(factoextra)

# Creazione del dataset da WiscNursingHome
Data <- read.csv("WiscNursingHome.csv", header = TRUE)

# Fattorizzazione delle variabili categoriali
Data$CRYEAR <- factor(Data$CRYEAR)
Data$MSA <- factor(Data$MSA)
Data$URBAN <- factor(Data$URBAN)
Data$PRO <- factor(Data$PRO)
Data$TAXEXEMPT <- factor(Data$TAXEXEMPT)
Data$SELFFUNDINS <- factor(Data$SELFFUNDINS)
Data$MCERT <- factor(Data$MCERT)
Data$ORGSTR <- factor(Data$ORGSTR)

# Ci sono alcuni dati mancanti?
na.id.Data <- apply(is.na(Data), 2, which) 
# Abbiamo 10 dati mancanti in SQRFOOT
na.SQRFOOT <- na.id.Data$SQRFOOT
# Data frame senza NA
DataNa <- Data[-na.SQRFOOT,]
```

### Analisi dei Grafici di Correlazione       
```{r echo=FALSE}
pairs(DataNa[ , -c(1, 2, 6, 7, 8, 9, 10, 11, 12)], panel = panel.smooth)
cormat <- cor(DataNa[, -c(1, 2, 6, 7, 8, 9, 10, 11, 12)]) 
corrplot(cormat, method="number")
```

Si può subito vedere come ci sia una correlazione quasi totale tra il *TPY* (totale patienti annui) e il *NUMBED* (numero di letti). Inoltre, si può osservare anche un'ottima correlazione tra il totale pazienti annui e i piedi quadrati della struttura (*SQRFOOT*), così come tra i piedi quadrati della struttura e il numero di letti. Ciò suggerisce che tutte queste variabili saranno legate tra loro da una relazione lineare.

Andiamo anche ad analizzare molto velocemente i grafici delle variabili qualitative:
```{r echo=FALSE}
p1 <- ggplot(data = Data, aes(x = CRYEAR, fill = CRYEAR)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p2 <- ggplot(data = Data, aes(x = MSA, fill = MSA)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p3 <- ggplot(data = Data, aes(x = URBAN, fill = URBAN)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p4 <- ggplot(data = Data, aes(x = PRO, fill = PRO)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p5 <- ggplot(data = Data, aes(x = TAXEXEMPT, fill = TAXEXEMPT)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p6 <- ggplot(data = Data, aes(x = SELFFUNDINS, fill = SELFFUNDINS)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p7 <- ggplot(data = Data, aes(x = MCERT, fill = MCERT)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

p8 <- ggplot(data = Data, aes(x = ORGSTR, fill = ORGSTR)) +
  geom_bar() +
  theme_classic() +
  theme(legend.position = "none") +
  ylab("")

# Grafico a torta della variabile MSA
ppie <- ggplot(Data, aes(x="", y="", fill=MSA)) +
  geom_bar(stat="identity", width=1) +
  coord_polar("y", start=0) +
  theme_void() 

# Grafico di tutti i grafici delle variabili categoriali
plot_grid(p1,p3,p4,p8,
          p5,p6,p7,ppie,
          nrow = 2)
```

-- abbiamo un problema con la visualizzazione del grafico a torta --


Andiamo anche a studiare velocemente le distribuzioni condizionate della variabile risposta:    

```{r echo=FALSE}
c4 <- ggplot(data = Data, aes(x = CRYEAR, y = TPY, fill = CRYEAR)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c5 <- ggplot(data = Data, aes(x = URBAN, y = TPY, fill = URBAN)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c6 <- ggplot(data = Data, aes(x = PRO, y = TPY, fill = PRO)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c7 <- ggplot(data = Data, aes(x = ORGSTR, y = TPY, fill = ORGSTR)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c8 <- ggplot(data = Data, aes(x = TAXEXEMPT, y = TPY, fill = TAXEXEMPT)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c9 <- ggplot(data = Data, aes(x = SELFFUNDINS, y = TPY, fill = SELFFUNDINS)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c10 <- ggplot(data = Data, aes(x = MCERT, y = TPY, fill = MCERT)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

c11 <- ggplot(data = Data, aes(x = MSA, y = TPY, fill = MSA)) +
  geom_boxplot() +
  theme_classic() +
  theme(legend.position = "")

plot_grid(c4, c5, c6, c7,
          c8, c9, c10, c11,
          nrow = 2)
```
```{r include=FALSE}
resiplot <- function(fit, p) {
  #p è il primo grafico in alto a sinistra, così non c'è il rischio che gli si passi un p a caso
  
  
  #per capire che data set utilizzare
  if(length(fitted.values(fit)) == 717){
    d = Data
    print("resi plot utilizzando Data")
  }
  if(length(fitted.values(fit)) == 707){
    d = DataNa
    print("resi plot utilizzando DataNa")
  }
  
  f <- ggplot(data = d, aes(x = fitted.values(fit), y = resid(fit))) +
    geom_point(shape=1) +
    theme_bw() +
    xlab("Valori fittati") +
    ylab("Residui") +
    geom_hline(yintercept = 0, col = "black", lty = 2) +
    geom_smooth(se = F, method = 'loess', formula = 'y ~ x', lwd = 0.75, col = "red")
  f1 <- ggplot(data = d, mapping = aes(resid(fit))) +
    geom_histogram(aes(y =after_stat(density)),bins = 20, col = "black", fill = "yellow", alpha = 1) + 
    geom_density(linewidth = 0.8, fill = "pink", alpha = 0.3) +
    theme_bw() +
    xlab("Residui") +
    ylab("Densità")
  f2 <- ggplot(data.frame(resid = rstandard(fit)),aes(sample = resid)) + 
    stat_qq(shape=1) +
    stat_qq_line(color = "red", linewidth = 1) +
    theme_bw() +
    xlab("Quantili teorici normale") +
    ylab("Quantili empirici")

  plot_grid(p, f,
            f1, f2,
            nrow = 2)
}
```

## REGRESSIONI LINEARI PER LA STIMA DI TPY

--- Proviamo prima le regressioni semplici con NUMBED e SQRFOOT    
Bisogna probabilmente scegliere una sola delle due variabili perché sono troppo correlate    
Poi proviamo ad aggiungere tutte le variabili qualitative e vediamo come incidono    
Modello ideale: 1 quantitativa + 1/2 qualitative (non è detto per forza) ---

#### Costruzione del modello TPY ~ NUMBED

```{r echo=FALSE}
fit_NUMBED <- lm(TPY ~ NUMBED, data = Data)
summary(fit_NUMBED)
```

Studiando i valori ritornati dal summary, si può subito vedere come questo modello sia ottimo: per quanto riguarda i residui, la mediana è molto vicina allo zero, il primo e il terzo quartile sono disposti abbastanza simmetricamente rispetto lo zero e discorso simile può essere fatto per i valori di minimo e massimo (magari il minimo è spostato più verso il basso, ma stiamo comunque parlando di valori "piccoli").     
Dal summary possiamo poi conoscere l'intercetta e il coefficiente angolare: l'intercetta vale -0.8778 (valore vicino allo zero, il che ha senso perché nel caso di 0 letti ci si aspetta un numero di pazienti vicino allo zero) mentre il coefficiente angolare è uguale a 0.9272 (valore vicino all'1, infatti per ogni posto letto in più ci si aspetta un paziente in più). Grazie a questi valori possiamo costruirci l'equazione della retta di regressione lineare:   
*TPY* = -0.8778 + 0.9272 * *NUMBED*.    
Infine, studiando la statistica R^2, possiamo vedere un valore pari a 0.9678, il quale suggerisce un'aderenza del modello ai dati molto alta, quasi totale, circa del 97%.      
-- (Attenzione il t value dell'intercetta non è motlo significativo al contrario dell'altro (che non mi viene il nome (coefficiente?))) (se non fosse per la poca significatività dell'intercetta potrebbe essere un modello quasi perfetto) --
